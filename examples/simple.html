<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="https://cdn.rawgit.com/necolas/normalize.css/master/normalize.css">

    <title>Simple</title>
</head>

<body>

    <div class="container" style="margin-top:2rem">

        <div class="row">
            <div class="column column-40">
                <audio controls id="record"></audio>
            </div>

        </div>

        <div class="row row-10"></div>
        <div class="row" style="margin-top:2rem">
            <div class="column column-10">
                <button id="start" class="button">Start</button>

            </div>
            <div class="column column-10">
                <button id="stop" class="button">Stop</button>

            </div>

        </div>

    </div>


    <script src="../dist/web-recorder.js"></script>
    <script>
        (function () {
            var audioRecorder;
            var audioContext;
            var stream;
            function onGotStream(stream) {
                stream = stream;
                audioContext = audioContext || new AudioContext()

                const inputPoint = audioContext.createGain()

                // Create an AudioNode from the stream.
                const audioInput = audioContext.createMediaStreamSource(stream)
                audioInput.connect(inputPoint)

                const analyserNode = audioContext.createAnalyser()
                analyserNode.fftSize = 2048
                inputPoint.connect(analyserNode)

                audioRecorder = new WebRecorder.Recorder(inputPoint)
                audioRecorder.addEventListener('started', console.log)
                audioRecorder.addEventListener('ended', console.log)

                const zeroGain = audioContext.createGain()
                zeroGain.gain.value = 0.0

                inputPoint.connect(zeroGain)
                zeroGain.connect(audioContext.destination)
                audioRecorder.addEventListener('ended', (ev) => {
                    var blobUrl = URL.createObjectURL(ev.detail);

                    const record = document.getElementById('record');
                    record.src = blobUrl;

                })
                audioRecorder.record()
            }
            document.getElementById('start').addEventListener('click', () => {
                navigator.getUserMedia({
                    audio: {
                        advanced: [{
                            echoCancelation: false
                        }]
                    }
                }, onGotStream, console.error)

            })
            document.getElementById('stop').addEventListener('click', () => {
                audioRecorder.stop();
            })
        })()

    </script>
</body>

</html>